#!/bin/sh

PROC_MAX_USAGE=80
PROC_MAX_TIME=5

procs=$(mktemp)
watched_procs=$(mktemp)

trap "/bin/rm ${procs} ${watched_procs}" EXIT

while [ : ]
do
    current_time=$(date +"%s")
    ps --no-headers -eo pid,%cpu,comm | grep -v $$ > ${procs}

    while read line
    do
        read pid cpu comm <<<$(echo $line)
        if [[ ${cpu/%.*} > ${PROC_MAX_USAGE} ]]; then
            watched_proc=$(grep ${pid} ${watched_procs})
            if [[ $? -eq 0 ]]; then
                read t p <<<$(echo $watched_proc)
                diff=$(( ${current_time} - ${t} ))
                if [[ ${diff} -ge ${PROC_MAX_TIME} ]]; then
                    logger -s -t $0 "killing process that exceded cpu and time threshold: ${pid}"
                    kill ${pid}
                    sed -i "/[0-9]* ${pid}/d" ${watched_procs}
                fi
            else 
                logger -s -t $0 "adding process to watch list: ${pid} (${comm})"
                echo ${current_time} ${pid} >> ${watched_procs}
            fi
        fi
    done < ${procs}

    while read line
    do
        read t p <<<$(echo ${line})
        diff=$(( ${current_time} - ${t} ))
        if [[ ${diff} -ge ${PROC_MAX_TIME} ]]; then
            logger -s -t $0 "removing process from watch list: ${p}"
            sed -i "/[0-9]* ${p}/d" ${watched_procs}
        fi
    done < ${watched_procs}

    sleep 1
done
